name: Infrastructure Deployment
on:
  push:
    branches: [ main ]
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:

env:
  TF_CLOUD_ORGANIZATION: "cypher682-org"
  TF_WORKSPACE: "stage6"

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_CLOUD_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform -chdir=infra/terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd infra/terraform
          terraform plan -detailed-exitcode -out=tfplan
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Detect Drift
        id: drift
        run: |
          if [ "${{ steps.plan.outputs.exitcode }}" = "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

  send-drift-alert:
    needs: terraform-plan
    if: needs.terraform-plan.outputs.drift_detected == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "DRIFT DETECTED – Approve Stage 6 Deployment"
          to: ${{ secrets.ALERT_EMAIL }}
          from: ${{ secrets.GMAIL_USER }}
          body: |
            Drift detected! Terraform wants to recreate the EC2 instance.
            Approve here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  terraform-apply:
    needs: [terraform-plan, send-drift-alert]
    if: always() && (needs.terraform-plan.outputs.drift_detected == 'false' || needs.send-drift-alert.result == 'success')
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_CLOUD_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Terraform Init & Apply
        run: |
          cd infra/terraform
          terraform init
          terraform apply -auto-approve

      - name: Output new public IP
        run: |
          cd infra/terraform
          IP=$(terraform output -raw instance_public_ip)
          echo "NEW_EC2_IP=$IP" >> $GITHUB_ENV
          echo "Update GoDaddy A records (@, app, auth, todos, users) → $IP"

  ansible-deploy:
    needs: terraform-apply
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Write SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/key
          chmod 600 /tmp/key

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: Generate fresh inventory
        run: |
          IP=$(cd infra/terraform && terraform output -raw instance_public_ip)
          cat > infra/ansible/inventory.ini <<EOF
          [app_server]
          $IP ansible_user=ubuntu ansible_ssh_private_key_file=/tmp/key ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Wait for SSH
        run: |
          until nc -z $IP 22; do sleep 5; done
          sleep 20

      - name: Run Ansible
        run: |
          cd infra/ansible
          ansible-playbook -i inventory.ini playbook.yml --private-key /tmp/key -v
