name: Infrastructure Deployment
on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
env:
  TF_CLOUD_ORGANIZATION: "cypher682-org"
  TF_WORKSPACE: "stage6"
  TF_API_TOKEN: "${{ secrets.TF_CLOUD_TOKEN }}"
jobs:
  terraform-plan:
    name: Terraform Plan and Drift Detection
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
   
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          cli_config_credentials_token: ${{ secrets.TF_CLOUD_TOKEN }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Terraform Init
        id: init
        run: |
          cd infra/terraform
          terraform init
      - name: Terraform Plan
        id: plan
        run: |
          cd infra/terraform
          terraform plan -detailed-exitcode -out=tfplan || echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      - name: Detect Drift
        id: drift
        run: |
          if [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "DRIFT DETECTED: Infrastructure changes are required"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "NO DRIFT: Infrastructure is up to date"
          fi
      - name: Save plan output
        if: steps.drift.outputs.drift_detected == 'true'
        run: |
          cd infra/terraform
          terraform show tfplan > plan_output.txt
      - name: Upload plan artifact
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/plan_output.txt
  send-drift-alert:
    name: Send Drift Detection Email
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.drift_detected == 'true'
   
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "DRIFT DETECTED - DevOps Stage 6 Infrastructure"
          to: ${{ secrets.ALERT_EMAIL }}
          from: ${{ secrets.GMAIL_USER }}
          body: |
            INFRASTRUCTURE DRIFT DETECTED
           
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
           
            Terraform has detected changes in your infrastructure.
           
            ACTION REQUIRED:
            Please review the plan and approve the workflow to apply changes.
           
            Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
           
            The plan output is attached to this email.
          attachments: plan_output.txt
      - name: Wait for manual approval
        run: |
          echo "Drift detected. Waiting for manual approval..."
          echo "Please review the plan and approve the workflow to continue."
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, send-drift-alert]
    if: always() && (needs.terraform-plan.outputs.drift_detected == 'false' || (needs.terraform-plan.outputs.drift_detected == 'true' && needs.send-drift-alert.result == 'success'))
    environment:
      name: production
   
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          cli_config_credentials_token: ${{ secrets.TF_CLOUD_TOKEN }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init
      - name: Terraform Apply
        run: |
          cd infra/terraform
          terraform apply -auto-approve
      - name: Get instance IP
        id: instance_ip
        run: |
          cd infra/terraform
          INSTANCE_IP=$(terraform output -raw instance_public_ip 2>&1 | grep -oE '[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}' | head -1)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "Instance IP: $INSTANCE_IP"
      - name: Display DNS configuration
        run: |
          echo "DNS Configuration Required:"
          echo "Create A record: app.cipherpol.xyz -> ${{ steps.instance_ip.outputs.instance_ip }}"
  ansible-deploy:
    name: Ansible Deployment
    runs-on: ubuntu-latest
    needs: terraform-apply
   
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          cli_config_credentials_token: ${{ secrets.TF_CLOUD_TOKEN }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init
      - name: Generate Ansible inventory
        run: |
          cd infra/terraform
          INSTANCE_IP=$(terraform output -raw instance_public_ip 2>&1 | grep -oE '[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}' | head -1)
          echo "[app_servers]" > ../ansible/inventory.ini
          echo "app_server ansible_host=$INSTANCE_IP ansible_user=ubuntu ansible_ssh_private_key_file=/tmp/ssh_key ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> ../ansible/inventory.ini
      - name: Setup SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible
      - name: Wait for instance to be ready
        run: sleep 60
      - name: Run Ansible playbook
        run: |
          cd infra/ansible
          ansible-playbook -i inventory.ini playbook.yml -v
      - name: Deployment complete
        run: |
          echo "Deployment completed successfully!"
          echo "Application should be available at: https://app.cipherpol.xyz"
