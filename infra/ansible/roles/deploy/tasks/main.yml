---
- name: Upgrade Docker to latest version
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: latest
    update_cache: yes
  become: yes

- name: Restart Docker service
  systemd:
    name: docker
    state: restarted
  become: yes

- name: Create application directory
  file:
    path: /home/ubuntu/app
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Check if repository exists
  stat:
    path: /home/ubuntu/app/.git
  register: git_repo

- name: Clone application repository
  git:
    repo: https://github.com/cypher682/DevOps-Stage-6.git
    dest: /home/ubuntu/app
    version: main
    force: yes
  become_user: ubuntu
  when: not git_repo.stat.exists

- name: Pull latest changes from repository
  git:
    repo: https://github.com/cypher682/DevOps-Stage-6.git
    dest: /home/ubuntu/app
    version: main
    force: yes
  become_user: ubuntu
  when: git_repo.stat.exists
  register: git_pull

- name: Stop existing containers
  shell: sg docker -c "docker compose down"
  args:
    chdir: /home/ubuntu/app
  become_user: ubuntu
  ignore_errors: yes
  when: git_pull.changed or not git_repo.stat.exists

- name: Remove old images
  shell: sg docker -c "docker compose down --rmi all"
  args:
    chdir: /home/ubuntu/app
  become_user: ubuntu
  ignore_errors: yes
  when: git_pull.changed or not git_repo.stat.exists

- name: Build and start containers
  shell: sg docker -c "docker compose up -d --build"
  args:
    chdir: /home/ubuntu/app
  become_user: ubuntu
  environment:
    DOCKER_BUILDKIT: "1"
  async: 900
  poll: 10
  register: docker_compose_up

- name: Wait for services to be healthy
  pause:
    seconds: 30

- name: Check running containers
  shell: sg docker -c "docker compose ps"
  args:
    chdir: /home/ubuntu/app
  become_user: ubuntu
  register: container_status
  changed_when: false

- name: Display container status
  debug:
    msg: "{{ container_status.stdout_lines }}"

- name: Check Traefik logs
  shell: sg docker -c "docker logs traefik --tail 50"
  become_user: ubuntu
  register: traefik_logs
  changed_when: false
  ignore_errors: yes

- name: Display Traefik logs
  debug:
    msg: "{{ traefik_logs.stdout_lines }}"
  when: traefik_logs is succeeded
